var n_lines = 1000;
var n_columns = 10;
var n_classes = 4;

function main(){
    var tab_mu = [];
    var tab_sigma = [];
    var tab_xi = [];
    var tab_y = [];

    createData(tab_mu, tab_sigma, tab_xi, tab_y);

    /*console.log("tab_mu : "+tab_mu);
    console.log("tab_sigma : "+tab_sigma);
    console.log("tab_xi : "+tab_xi);
    console.log("tab_y : "+tab_y);*/

    classify([100, 10, 8.5, 45, 800, 10, 25, 47, 84, 700], tab_xi, tab_y, 3);


}

exports.main = main();


function createData(tab_mu, tab_sigma, tab_xi, tab_y){

    for(var i = 0; i < n_columns; i++){
        tab_mu[i] = Math.floor(Math.random() * 1000 - 500);
        tab_sigma[i] = Math.floor(Math.abs(tab_mu[i] / 10) + Math.random() * 10);
        tab_xi[i] = [];
        for(var j = 0; j < n_lines; j++){
            tab_xi[i][j] = tab_sigma[i] * generateZ() + tab_mu[i];
        }
    }
    generateClasses(tab_y);
}

function generateZ(){
    return Math.floor(Math.sqrt(-2*Math.log(Math.random()))*Math.cos(2*Math.PI*Math.random()));
}

function generateClasses(tab_y){
    for(var i = 0; i < n_lines; i++){
        tab_y[i] = Math.floor(Math.random() * n_classes) + 1;
    }
}

/*
     Règle : Si Xi < ? ... && Xp > ?? alors Y = ?
     Très dépendnant => Règle pour tous les Xi
     Partiellement => Règle pour les 3 premiers Xi
     Totalement indépendant => Random entre tous les Xi
 */

/*
    Algo :
        Calcule la distance entre le vecteur qu'on lui passe et l'ensemble des données
        Récupère les k plus courtes distances
        Affecter au vecteur donné la classe majoritaire dans k plus courtes distances
 */

function classify(vector_to_classify, data, classes, k){
    var tab_distance = [];
    var tmp = 0;

    for(var j = 0; j < n_lines; j++){
        var column = data.map(function(value, index){ return value[j]; });
        tab_distance[j] = getDistance(vector_to_classify, column);
    }

    var tab_distance_sorted = tab_distance.sort(function(a,b){return a-b});
    var new_class = getClassMajority(tab_distance, tab_distance_sorted.slice(0, k), classes);
    console.log("new_class : "+new_class);
}

function getClassMajority(tab_distance, tab_distance_sorted, classes){
    var i;
    var tab = initTab(n_classes);
    tab_distance_sorted.forEach(function(element_sorted, index){
        tab[classes[tab_distance.indexOf(element_sorted)]-1] += 1;
    });
    return tab.indexOf(Math.max.apply(null, tab)) + 1;
}


function getDistance(v1, v2){
    var distance = 0;
    v1.forEach(function(element, index){
        distance += Math.pow((element - v2[index]), 2);
    });
    return Math.sqrt(distance);
}

function initTab(n){
    var tab = [];
    for(var i = 0; i < n; i++){
        tab[i] = 0;
    }
    return tab;
}